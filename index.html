<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>chat</title>
	<link rel="icon" href="./favicon.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="CHAT">
	<link rel="apple-touch-icon" href="./favicon.png">
	<meta name="theme-color" content="#0b0b0d">
	<style>
		:root {
			--bg-dark: #0b0b0d;
			--border-gray: #333;
			--border-light: #666;
			--accent-cyan: hsl(180,100%,50%);
			--accent-red: hsl(0,100%,50%);
			--white: white;
			--font-lg: 1.5rem;
			--font-md: 1rem;
			--spacing: 1rem;
			--spacing-half: 0.5rem;
			--border-width: 2px;
		}
		@font-face { font-family: 'PerfectDOS'; src: url('./PerfectDosVga.ttf') format('truetype'); }
		* { font-family: 'PerfectDOS', monospace; margin: 0; padding: 0; box-sizing: border-box; }
		html, body { 
			height: 100%; 
			overflow: hidden; 
			background: var(--bg-dark); 
			color: var(--white); 
			margin: 0; 
			padding: 0; 
		}
		body { border: 1px solid var(--accent-cyan); }
		.login-overlay { position: fixed; inset: 0; background: rgba(40, 40 ,40, 0.7); display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; z-index: 100; }
		.login-overlay h1 { color: var(--accent-cyan); font-size: 3rem; margin-bottom: var(--spacing); }
		.enter-btn { background: var(--accent-cyan); color: var(--bg-dark); padding: 16px 48px; border: none; font-size: var(--font-lg); cursor: pointer; }
		#chat-app { display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
		#header-area { border-bottom: var(--border-width) solid var(--border-gray); display: flex; padding: 0.25rem var(--spacing-half); align-items: center; gap: 0.25rem; overflow: hidden; justify-content: space-between; }
		#logoutBtn { padding: 2px 4px; font-size: var(--font-md); background: var(--border-gray); color: var(--accent-red); border: none; outline: none; width: auto; cursor: pointer; white-space: nowrap; -webkit-appearance: none; appearance: none; }
		#logoutBtn:hover { opacity: 0.8; }
		#messages { flex: 1; padding: var(--spacing); overflow-y: scroll; overflow-x: hidden; min-height: 0; }
		#messages::-webkit-scrollbar { width: 1ch; }
		#messages::-webkit-scrollbar-track { background: var(--bg-dark); }
		#messages::-webkit-scrollbar-thumb { background: var(--accent-cyan); }
		#messages-wrapper { display: flex; flex-direction: column; min-height: min-content; }
		.message { position: relative; font-size: var(--font-lg); padding: var(--spacing-half) var(--spacing); margin: 0.6rem 0; max-width: 95%; align-self: flex-end; background: var(--bg-dark); border: var(--border-width) solid; }
		.message .name { position: absolute; top: -0.6em; left: .6em; font-size: var(--font-lg); background: var(--bg-dark); }
		.message .time { position: absolute; bottom: -0.6em; right: .6em; font-size: var(--font-lg); transform: scaleY(0.6); background: var(--bg-dark); }
		.date-separator {
			align-self: center;
			margin: 1rem 0 0.5rem 0;
			padding: 0.25rem 0.75rem;
			font-size: var(--font-md);
			color: var(--border-light); 
			border: 1px solid var(--border-gray);
			background: var(--bg-dark);
		}
		#input-area { border-top: var(--border-width) solid var(--border-gray); display: flex; }
		#input-area input { flex: 1; padding: var(--spacing); font-size: var(--font-lg); background: var(--bg-dark); color: var(--accent-cyan); border: none; outline: none; min-width: 0; }
		#send-btn { padding: var(--spacing) 1.5rem; font-size: var(--font-lg); background: var(--border-gray); color: var(--white); border: none; border-left: var(--border-width) solid var(--border-gray); cursor: pointer; flex-shrink: 0; }
		.modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: rgba(11,11,13,0.85); }
		.modal-content { border: var(--border-width) solid var(--white); padding: 2rem; min-width: 300px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; background: var(--bg-dark); }
		.modal-header { font-size: var(--font-lg); margin-bottom: 1rem; color: var(--accent-cyan); }
		.modal input { width: 100%; background: #222; color: var(--white); border: var(--border-width) solid var(--border-light); padding: 12px; font-size: 16px; outline: none; margin: 10px 0; }
		.modal button { padding: 12px; border: none; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; background: var(--border-gray); color: var(--white); }
		.error { color: #f00; margin: 10px 0; }
		.color-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 6px; margin: 10px 0; }
		.color-option { aspect-ratio: 1; cursor: pointer; border: 2px solid; }
		.color-option.selected { border-color: white; box-shadow: 0 0 8px rgba(255,255,255,1); }
	</style>
</head>
<body>
	<div id="app">
		<div id="chat-app">
			<div id="header-area"></div>
			<div id="messages">
				<div id="messages-wrapper"></div>
			</div>
			<div id="input-area">
				<input type="text" id="messageInput" placeholder="Type...">
				<button id="send-btn">SEND</button>
			</div>
		</div>
	</div>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
		import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js';
		import { getDatabase, ref, push, onChildAdded, set, get } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js';

		const app = initializeApp({
			apiKey: "AIzaSyB-UPrXMblPcO1gcdD0GuEhBA8JGMpbGs4",
			authDomain: "social-e02b4.firebaseapp.com",
			databaseURL: "https://social-e02b4-default-rtdb.firebaseio.com",
			projectId: "social-e02b4",
			storageBucket: "social-e02b4.firebasestorage.app",
			messagingSenderId: "64302705629",
			appId: "1:64302705629:web:9090276dba0418cee6e434"
		});

		const auth = getAuth(app);
		const db = getDatabase(app);
		
		const COLORS = [180, 210, 240, 270, 300, 330, 0, 30, 60, 90, 120, 150];
		const COLOR_NAMES = {
			180: 'Cyan', 210: 'Sky', 240: 'Blue', 270: 'Purple', 300: 'Magenta', 330: 'Pink',
			0: 'Red', 30: 'Orange', 60: 'Yellow', 90: 'Lime', 120: 'Green', 150: 'Teal'
		};

		let state = {
			user: null,
			username: '',
			color: '180',
			borderStyle: 'solid',
			input: '',
			showUsernamePrompt: false,
			usernameInput: '',
			error: '',
			isLoading: false,
		};

		const loadedIds = new Set();
		let lastDisplayedDate = null; 

		document.getElementById('messageInput').oninput = e => state.input = e.target.value;
		document.getElementById('messageInput').onkeypress = e => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		};
		document.getElementById('send-btn').onclick = sendMessage;

		onChildAdded(ref(db, 'messages'), async snapshot => {
			const id = snapshot.key;
			if (loadedIds.has(id)) return;
			loadedIds.add(id);

			const msg = snapshot.val();
			addMessageToDOM(msg.userName, msg.text, msg.color, msg.borderStyle, msg.timestamp);
			
			if (msg.userId !== state.user?.uid && Notification.permission === 'granted') {
				new Notification(`${msg.userName}`, {
					body: msg.text,
					icon: './favicon.png'
				});
			}
		});

		function getDateKey(dateObj) {
			return dateObj.getFullYear() + '-' + (dateObj.getMonth() + 1) + '-' + dateObj.getDate();
		}

		function addMessageToDOM(userName, text, color, borderStyle, timestamp) {
			const container = document.getElementById('messages-wrapper');
			if (!container) return;

			const time = new Date(timestamp);
			const currentDateKey = getDateKey(time);
			
			if (lastDisplayedDate === null || lastDisplayedDate !== currentDateKey) {
				const separator = document.createElement('div');
				separator.className = 'date-separator';
				
				const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
				separator.textContent = time.toLocaleDateString(undefined, dateOptions).toUpperCase();
				
				container.appendChild(separator);
				lastDisplayedDate = currentDateKey;
			}
			
			const minLength = 5;
			const requiredMinLength = Math.max(minLength, userName.length);
			
			if (text.length < requiredMinLength) {
				const paddingNeeded = requiredMinLength - text.length;
				const padding = '\u00a0'.repeat(paddingNeeded); 
				text = text + padding;
			}
			
			const el = document.createElement('div');
			el.className = 'message';
			
			const light = `hsl(${color},100%,50%)`;
			const dark = `hsl(${color},100%,30%)`;
			el.style.color = light;
			el.style.borderColor = dark;
			el.style.borderStyle = borderStyle;
			
			const timeStr = `${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
			
			el.innerHTML = `
				<span class="name" style="color:${dark}">${userName}</span>
				<span class="text">${text}</span>
				<span class="time" style="color:${dark}">${timeStr}</span>
			`;
			
			container.appendChild(el);

			const messagesContainer = document.getElementById('messages');
			if (messagesContainer) {
				messagesContainer.scrollTop = messagesContainer.scrollHeight;
			}
		}

		async function sendMessage() {
			if (!state.user || !state.input.trim()) return;
			
			const text = state.input.trim();
			
			await push(ref(db, 'messages'), {
				userId: state.user.uid,
				userName: state.username,
				text: text,
				timestamp: Date.now(), 
				color: state.color,
				borderStyle: state.borderStyle
			});
			
			state.input = '';
			document.getElementById('messageInput').value = '';
		}

		function enterChat() {
			state.isLoading = true;
			renderOverlay();
			signInAnonymously(auth).catch(err => {
				console.error('Auth error:', err);
				state.error = 'Failed to enter chat: ' + err.message;
				state.isLoading = false;
				renderOverlay();
			});
		}

		function confirmUsername() {
			const un = state.usernameInput.trim();
			if (!un) {
				state.error = 'Enter a username';
				renderOverlay();
				return;
			}
			
			if (un.length < 2 || un.length > 10) {
				state.error = 'Username must be 2-10 characters';
				renderOverlay();
				return;
			}
			
			set(ref(db, `users/${state.user.uid}`), {
				username: un,
				color: state.color,
				borderStyle: state.borderStyle
			});
			
			state.username = un;
			state.showUsernamePrompt = false;
			state.error = '';
			renderOverlay();
		}

		function renderOverlay() {
			const existing = document.getElementById('overlay');
			if (existing) existing.remove();

			if (!state.user) {
				const div = document.createElement('div');
				div.id = 'overlay';
				div.className = 'login-overlay';
				div.innerHTML = `
					<h1>CHAT</h1>
					${state.error ? `<div class="error">${state.error}</div>` : ''}
					${state.isLoading ? 'Loading...' : '<button class="enter-btn" id="enterBtn">ENTER</button>'}
				`;
				document.body.appendChild(div);
				if (!state.isLoading) {
					document.getElementById('enterBtn').onclick = enterChat;
				}
				return;
			}

			if (state.showUsernamePrompt) {
				const div = document.createElement('div');
				div.id = 'overlay';
				div.className = 'modal';
				div.innerHTML = `
					<div class="modal-content">
						<div class="modal-header">CHOOSE USERNAME</div>
						${state.error ? `<div class="error">${state.error}</div>` : ''}
						<input id="unInput" type="text" value="${state.usernameInput}" maxlength="10" placeholder="Username" autocomplete="off">
						<div style="margin: 1.5rem 0;">
							<div style="color: white; margin-bottom: 0.8rem;">COLOR</div>
							<div class="color-grid" id="colorGrid">
								${COLORS.map(h => `<div class="color-option ${state.color==h?'selected':''}" data-color="${h}" style="background:hsl(${h},100%,50%);"></div>`).join('')}
							</div>
						</div>
						<button id="confirmBtn">START CHATTING</button>
					</div>
				`;
				document.body.appendChild(div);
				const input = document.getElementById('unInput');
				input.focus();
				input.oninput = e => state.usernameInput = e.target.value;
				input.onkeypress = e => {
					if (e.key === 'Enter') {
						e.preventDefault();
						confirmUsername();
					}
				};
				document.querySelectorAll('.color-option').forEach(el => {
					el.onclick = () => {
						state.color = el.dataset.color;
						renderOverlay();
					};
				});
				document.getElementById('confirmBtn').onclick = confirmUsername;
				return;
			}

			const header = document.getElementById('header-area');
			if (header) {
				const userColor = `hsl(${state.color},100%,50%)`;
				header.innerHTML = `
					<span style="color: ${userColor}; font-size: var(--font-lg); font-weight: bold;">${state.username}</span>
					<button id="logoutBtn">LEAVE</button>
				`;
				
				document.getElementById('logoutBtn').onclick = async () => {
					state.user = null;
					state.username = '';
					state.showUsernamePrompt = false;
					lastDisplayedDate = null; 
					await signOut(auth);
					renderOverlay();
				};
				
				const messageInput = document.getElementById('messageInput');
				if (messageInput) {
					messageInput.style.color = `hsl(${state.color},100%,50%)`;
				}
				
				const sendBtn = document.getElementById('send-btn');
				if (sendBtn) {
					sendBtn.style.color = `hsl(${state.color},100%,50%)`;
				}
				
				document.body.style.borderColor = `hsl(${state.color},100%,50%)`;
				const style = document.createElement('style');
				style.id = 'dynamic-scrollbar';
				const existingStyle = document.getElementById('dynamic-scrollbar');
				if (existingStyle) existingStyle.remove();
				style.textContent = `#messages::-webkit-scrollbar-thumb { background: hsl(${state.color},100%,50%); }`;
				document.head.appendChild(style);
			}
		}

		onAuthStateChanged(auth, async user => {
			if (user) {
				const snap = await get(ref(db, `users/${user.uid}`));
				if (!snap.exists() || !snap.val()?.username) {
					state.user = user;
					state.showUsernamePrompt = true;
				} else {
					state.user = user;
					const data = snap.val();
					state.username = data.username;
					state.color = data.color || '180';
					state.borderStyle = data.borderStyle || 'solid';
					state.showUsernamePrompt = false;
					
					if (Notification.permission === 'default') {
						Notification.requestPermission();
					}
				}
			} else {
				state.user = null;
				state.username = '';
				state.showUsernamePrompt = false;
			}
			state.isLoading = false;
			renderOverlay();
		});

		renderOverlay();
	</script>
</body>
</html>