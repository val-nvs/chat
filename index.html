<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>chat</title>
	<style>
		@font-face {
			font-family: 'PerfectDOS';
			src: url('./PerfectDosVga.ttf') format('truetype');
		}
		* { font-family: 'PerfectDOS', monospace; margin: 0; padding: 0; box-sizing: border-box; }
		html, body { height: 100%; overflow: hidden; background: #0b0b0d; color: white; }
		
		body {
			border: 1px solid hsl(180,100%,50%);
			box-sizing: border-box;
		}
		
		.login-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(11,11,13,0.95);
			backdrop-filter: blur(8px);
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			gap: 20px;
			z-index: 100;
		}
		.login-overlay h1 { 
			color: hsl(180,100%,50%); 
			font-size: 3rem; 
			margin-bottom: 1rem;
			animation: pulse 2s ease-in-out infinite;
		}
		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.7; }
		}
		.enter-btn {
			background: hsl(180,100%,50%);
			color: #0b0b0d;
			padding: 16px 48px;
			border: none;
			font-size: 1.5rem;
			cursor: pointer;
			transition: all 0.3s;
		}
		.enter-btn:hover {
			transform: scale(1.05);
			box-shadow: 0 0 20px hsla(180,100%,50%,0.5);
		}
		
		#chat-app { 
			display: flex; 
			flex-direction: column; 
			height: 100dvh;
			overflow: hidden;
		}
		#header-area {
			border-bottom: 2px solid #333;
			display: grid;
			grid-template-columns: auto auto auto auto 1px auto auto auto;
			padding: 0.25rem 0.5rem;
			align-items: center;
			gap: 0.25rem;
			overflow: hidden;
		}
		#header-area input, #header-area select {
			background: #0b0b0d;
			color: white;
			border: 2px solid #666;
			padding: 2px 4px;
			font-size: 0.85rem;
			outline: none;
			overflow: hidden;
			text-overflow: clip;
			width: 100%;
			min-width: 0;
		}
		#header-area select {
			cursor: pointer;
		}
		#header-area select option {
			background: #0b0b0d;
		}
		#username-input {
			min-width: 0;
		}
		#color-select, #border-select, #sound-theme-select, #animations-select {
			min-width: 0;
		}
		#update-btn {
			color: #0b0b0d;
			padding: 2px 8px;
			border: 2px solid;
			cursor: pointer;
			font-size: 0.85rem;
			white-space: nowrap;
		}
		#update-btn:hover {
			opacity: 0.8;
		}
		.header-divider {
			width: 1px;
			height: 16px;
			background: #333;
			margin: 0;
			flex-shrink: 0;
		}
		#animations-toggle {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			padding: 4px 8px;
			border: 2px solid #666;
			background: #0b0b0d;
		}
		#animations-toggle input[type="checkbox"] {
			cursor: pointer;
		}
		.floating-controls {
			position: fixed;
			top: 1rem;
			left: 1rem;
			display: none;
			gap: 10px;
			z-index: 1000;
			pointer-events: none;
		}
		.logout-btn { 
			padding: 2px 6px;
			background: rgba(11,11,13,0.9);
			border: 2px solid hsl(0,100%,50%);
			backdrop-filter: blur(10px);
			cursor: pointer;
			color: hsl(0,100%,50%);
			font-size: 0.85rem;
			pointer-events: auto;
			white-space: nowrap;
			justify-self: end;
			min-width: 0;
		}
		
		#messages {
			flex: 1;
			padding: 1rem;
			overflow-y: scroll;
			overflow-x: hidden;
			min-height: 0;
			-webkit-overflow-scrolling: touch;
		}
		#messages::-webkit-scrollbar {
			width: 1ch;
		}
		#messages::-webkit-scrollbar-track {
			background: #0b0b0d;
		}
		#messages::-webkit-scrollbar-thumb {
			background: hsl(180,100%,50%);
		}
		#messages-wrapper {
			display: flex;
			flex-direction: column;
			min-height: min-content;
		}
		.message {
			position: relative;
			font-size: 1.5rem;
			padding: 0.5rem 1rem;
			margin: 0.6rem 0;
			max-width: 60%;
			align-self: flex-end;
			background: #0b0b0d;
			border: 2px solid;
			transition: transform 0.1s;
		}
		.message.youtube {
			max-width: 80%;
		}
		.message iframe {
			width: 100%;
			aspect-ratio: 16/9;
			border: none;
			display: block;
			margin-top: 0.5rem;
		}
		.message:hover { transform: translateX(-2px); }
		.message .name, .message .time { position: absolute; background: #0b0b0d; }
		.message .name { top: -0.6em; left: .6em; font-size: 1.5rem; }
		.message .time { bottom: -0.6em; right: .6em; font-size: 1rem; }
		
		.system-message {
			align-self: flex-start;
			font-size: 1.5rem;
			color: white;
			background: transparent;
			border: 1px dashed #666;
			padding: 0.5rem 1rem;
			margin: 0.6rem 0;
			max-width: 60%;
			position: relative;
		}
		.system-message:hover { transform: none; }
		.system-message .highlight {
			font-weight: bold;
		}
		.system-message .time {
			position: absolute;
			background: #0b0b0d;
			bottom: -0.6em;
			right: .6em;
			font-size: 1rem;
			color: #666;
		}
		
		#input-area { border-top: 2px solid #333; display: flex; }
		#input-area input {
			flex: 1;
			padding: 1rem;
			font-size: 1.5rem;
			background: #0b0b0d;
			color: hsl(var(--user-color, 180),100%,50%);
			border: none;
			outline: none;
			min-width: 0;
		}
		#send-btn {
			padding: 1rem 1.5rem;
			font-size: 1.5rem;
			background: #0b0b0d;
			color: white;
			border: none;
			border-left: 2px solid #333;
			cursor: pointer;
			flex-shrink: 0;
		}
		
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(11,11,13,0.5);
			backdrop-filter: blur(8px);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 2000;
		}
		.modal-content {
			background: #0b0b0d;
			border: 2px solid white;
			padding: 2rem;
			min-width: 300px;
			max-width: 500px;
			width: 90%;
			max-height: 80vh;
			overflow-y: auto;
		}
		.modal-header {
			color: white;
			font-size: 1.5rem;
			margin-bottom: 1rem;
			display: flex;
			justify-content: space-between;
		}
		.modal input, .modal textarea {
			width: 100%;
			background: #0b0b0d;
			color: white;
			border: 2px solid #666;
			padding: 12px;
			font-size: 16px;
			outline: none;
			margin: 10px 0;
		}
		.modal button {
			background: white;
			color: #0b0b0d;
			padding: 12px;
			border: none;
			cursor: pointer;
			width: 100%;
			font-size: 16px;
			margin-top: 10px;
		}
		.error { color: hsl(0,100%,50%); font-size: 0.9rem; margin-bottom: 10px; }
		
		.style-section { margin-top: 1.5rem; }
		.style-label {
			color: white;
			font-size: 1rem;
			margin-bottom: 0.8rem;
			display: block;
		}
		.color-grid {
			display: grid;
			grid-template-columns: repeat(12, 1fr);
			gap: 6px;
			margin-bottom: 1rem;
		}
		.color-option {
			aspect-ratio: 1;
			border: 2px solid transparent;
			cursor: pointer;
			transition: all 0.2s;
			width: 100%;
			height: 100%;
		}
		.color-option.selected {
			border-color: white;
			box-shadow: 0 0 8px rgba(255,255,255,0.5);
		}
		.border-options { display: flex; gap: 8px; }
		.border-option {
			flex: 1;
			padding: 8px;
			background: #0b0b0d;
			cursor: pointer;
			text-align: center;
			transition: all 0.2s;
			font-size: 0.85rem;
		}
		.border-option.selected {
			border-color: white;
			box-shadow: 0 0 8px rgba(255,255,255,0.5);
		}
		.loading {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid rgba(255,255,255,0.3);
			border-top-color: hsl(180,100%,50%);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-left: 10px;
		}
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
	</style>
</head>
<body>
	<div id="app">
		<div id="chat-app">
			<div id="header-area"></div>
			<div id="messages">
				<div id="messages-wrapper"></div>
			</div>
			<div id="input-area">
				<input type="text" id="messageInput" placeholder="Type...">
				<button id="send-btn">SEND</button>
			</div>
		</div>
	</div>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
		import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js';
		import { getDatabase, ref, push, onChildAdded, set, get, onDisconnect, onValue } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js';

		const app = initializeApp({
			apiKey: "AIzaSyB-UPrXMblPcO1gcdD0GuEhBA8JGMpbGs4",
			authDomain: "social-e02b4.firebaseapp.com",
			databaseURL: "https://social-e02b4-default-rtdb.firebaseio.com",
			projectId: "social-e02b4",
			storageBucket: "social-e02b4.firebasestorage.app",
			messagingSenderId: "64302705629",
			appId: "1:64302705629:web:9090276dba0418cee6e434"
		});

		const auth = getAuth(app);
		const db = getDatabase(app);
		const COLORS = [180, 210, 240, 270, 300, 330, 0, 30, 60, 90, 120, 150];

		let state = {
			user: null,
			username: '',
			color: '180',
			borderStyle: 'solid',
			input: '',
			showUsernamePrompt: false,
			usernameInput: '',
			error: '',
			isLoading: false,
			lastAnimatedId: null,
			hasJoinedChat: false,
			timeoutMsgRef: null,
			soundTheme: 'default',
			animationsEnabled: true
		};

		const messages = [];
		const loadedIds = new Set();
		
		const soundThemes = {
			default: {
				typing: './sounds/default/type.wav',
				finish: './sounds/default/message.wav',
				enter: './sounds/default/load.wav',
				userJoined: './sounds/default/join.wav'
			},
			msn: {
				typing: './sounds/msn/type.wav',
				finish: './sounds/msn/message.wav',
				enter: './sounds/msn/load.wav',
				userJoined: './sounds/msn/join.wav'
			},
			silent: {
				typing: null,
				finish: null,
				enter: null,
				userJoined: null
			}
		};
		
		let typingSound = new Audio(soundThemes.default.typing);
		let finishSound = new Audio(soundThemes.default.finish);
		let enterSound = new Audio(soundThemes.default.enter);
		let userJoinedSound = new Audio(soundThemes.default.userJoined);
		
		function updateSoundTheme(theme) {
			state.soundTheme = theme;
			const sounds = soundThemes[theme];
			if (sounds.typing) {
				typingSound = new Audio(sounds.typing);
			}
			if (sounds.finish) {
				finishSound = new Audio(sounds.finish);
			}
			if (sounds.enter) {
				enterSound = new Audio(sounds.enter);
			}
			if (sounds.userJoined) {
				userJoinedSound = new Audio(sounds.userJoined);
			}
		}

		document.getElementById('messageInput').oninput = e => state.input = e.target.value;
		document.getElementById('messageInput').onkeypress = e => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		};
		document.getElementById('send-btn').onclick = sendMessage;

		onChildAdded(ref(db, 'messages'), snapshot => {
			const id = snapshot.key;
			if (loadedIds.has(id)) return;
			loadedIds.add(id);

			const msg = { id, ...snapshot.val() };
			messages.push(msg);
			if (messages.length > 30) messages.shift();

			addMessageToDOM(msg, true);
		});

		function addMessageToDOM(msg, animate) {
			const container = document.getElementById('messages-wrapper');
			if (!container) return;

			while (container.children.length >= 30) {
				container.removeChild(container.firstChild);
			}

			const el = document.createElement('div');
			const isSystem = msg.type === 'system';
			el.className = isSystem ? 'system-message' : 'message';
			
			if (isSystem) {
				if (msg.oldColor && msg.newColor) {
					const parts = msg.text.split(' is now ');
					if (parts.length === 2) {
						const oldName = parts[0];
						const newName = parts[1];
						const oldColorStyle = `hsl(${msg.oldColor},100%,50%)`;
						const newColorStyle = `hsl(${msg.newColor},100%,50%)`;
						el.innerHTML = `<span class="highlight" style="color: ${oldColorStyle}">${oldName}</span> is now <span class="highlight" style="color: ${newColorStyle}">${newName}</span><span class="time">${formatTime(msg.timestamp)}</span>`;
					} else {
						const words = msg.text.split(' ');
						const username = words[0];
						const action = words.slice(1).join(' ');
						const userColor = msg.oldColor ? `hsl(${msg.oldColor},100%,50%)` : 'white';
						el.innerHTML = `<span class="highlight" style="color: ${userColor}">${username}</span> ${action}<span class="time">${formatTime(msg.timestamp)}</span>`;
						
						// Play sound if user joined
						if (action === 'joined' && animate && state.soundTheme !== 'silent') {
							userJoinedSound.currentTime = 0;
							userJoinedSound.play().catch(() => {});
						}
					}
				} else {
					const parts = msg.text.split(' ');
					if (parts.length >= 2) {
						const username = parts[0];
						const action = parts.slice(1).join(' ');
						const userColor = msg.userColor ? `hsl(${msg.userColor},100%,50%)` : 'white';
						el.innerHTML = `<span class="highlight" style="color: ${userColor}">${username}</span> ${action}<span class="time">${formatTime(msg.timestamp)}</span>`;
					} else {
						el.innerHTML = `${msg.text}<span class="time">${formatTime(msg.timestamp)}</span>`;
					}
				}
			} else {
				const light = `hsl(${msg.color},100%,50%)`;
				const dark = `hsl(${msg.color},100%,30%)`;
				el.style.color = light;
				el.style.borderColor = dark;
				el.style.borderStyle = msg.borderStyle;
				
				if (msg.youtubeId) {
					el.classList.add('youtube');
					el.innerHTML = `
						<span class="name" style="color:${dark}"></span>
						<span class="text"></span>
						<iframe src="https://www.youtube.com/embed/${msg.youtubeId}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
						<span class="time" style="color:${dark}">${formatTime(msg.timestamp)}</span>
					`;
				} else {
					el.innerHTML = `
						<span class="name" style="color:${dark}"></span>
						<span class="text"></span>
						<span class="time" style="color:${dark}">${formatTime(msg.timestamp)}</span>
					`;
				}
				
				if (animate && state.user && state.animationsEnabled) {
					animateMessage(el, msg.userName, msg.text);
				} else {
					el.querySelector('.name').textContent = msg.userName;
					el.querySelector('.text').textContent = msg.text;
					if (animate && state.user && state.soundTheme !== 'silent') {
						finishSound.currentTime = 0;
						finishSound.play().catch(() => {});
					}
				}
			}
			
			container.appendChild(el);

			const messagesContainer = document.getElementById('messages');
			if (messagesContainer) {
				messagesContainer.scrollTop = messagesContainer.scrollHeight;
			}
		}

		function animateMessage(el, userName, text) {
			const nameEl = el.querySelector('.name');
			const textEl = el.querySelector('.text');
			if (!nameEl || !textEl) return;
			
			let ni = 0, ti = 0;
			function type() {
				let typed = false;
				if (ni < userName.length) {
					nameEl.textContent += userName[ni++];
					typed = true;
				}
				if (ti < text.length) {
					textEl.textContent += text[ti++];
					typed = true;
				}
				
				if (typed && state.soundTheme !== 'silent' && state.animationsEnabled) {
					typingSound.currentTime = 0;
					typingSound.play().catch(() => {});
				}
				
				document.getElementById('messages').scrollTop = 9999;
				
				if (ni < userName.length || ti < text.length) {
					setTimeout(type, 80);
				} else {
					if (state.soundTheme !== 'silent' && state.animationsEnabled) {
						finishSound.currentTime = 0;
						finishSound.play().catch(() => {});
					}
				}
			}
			type();
		}

		function formatTime(ts) {
			const d = new Date(ts);
			return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
		}

		async function sendMessage() {
			if (!state.user || !state.input.trim()) return;
			
			const text = state.input.trim();
			let messageData = {
				userId: state.user.uid,
				userName: state.username,
				text: text,
				timestamp: Date.now(),
				color: state.color,
				borderStyle: state.borderStyle,
				type: 'user'
			};
			
			// Check if message is a YouTube link
			const youtubeRegex = /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
			const match = text.match(youtubeRegex);
			if (match) {
				const videoId = match[3];
				messageData.youtubeId = videoId;
				messageData.text = `youtube.com/watch?v=${videoId}`;
			}
			
			const msgRef = await push(ref(db, 'messages'), messageData);
			state.lastAnimatedId = msgRef.key;
			state.input = '';
			document.getElementById('messageInput').value = '';
		}

		async function sendSystemMessage(text, oldColor = null, newColor = null) {
			await push(ref(db, 'messages'), {
				text: text,
				timestamp: Date.now(),
				type: 'system',
				oldColor: oldColor,
				newColor: newColor
			});
		}

		async function enterChat() {
			state.isLoading = true;
			renderOverlay();
			try {
				await signInAnonymously(auth);
			} catch (err) {
				console.error('Auth error:', err);
				state.error = 'Failed to enter chat';
				state.isLoading = false;
				renderOverlay();
			}
		}

		async function confirmUsername() {
			const un = state.usernameInput.trim();
			if (!un) {
				state.error = 'Enter a username';
				renderOverlay();
				return;
			}
			
			if (un.length < 2 || un.length > 10) {
				state.error = 'Username must be 2-10 characters';
				renderOverlay();
				return;
			}
			
			await set(ref(db, `users/${state.user.uid}`), {
				username: un,
				color: state.color,
				borderStyle: state.borderStyle
			});
			
			state.username = un;
			state.showUsernamePrompt = false;
			state.error = '';
			
			if (!state.hasJoinedChat) {
				await sendSystemMessage(`${un} joined`, state.color, state.color);
				state.hasJoinedChat = true;
				await setupPresence();
				
				if (state.soundTheme !== 'silent') {
					enterSound.currentTime = 0;
					enterSound.play().catch(() => {});
				}
			}
			
			renderOverlay();
		}

		function renderOverlay() {
			const existing = document.getElementById('overlay');
			if (existing) existing.remove();
			
			const existing2 = document.getElementById('controls');
			if (existing2) existing2.remove();

			if (!state.user) {
				const div = document.createElement('div');
				div.id = 'overlay';
				div.className = 'login-overlay';
				div.innerHTML = `
					<h1>CHAT</h1>
					${state.error ? `<div class="error">${state.error}</div>` : ''}
					${state.isLoading ? 
						'<div class="loading"></div>' : 
						'<button class="enter-btn" id="enterBtn">ENTER</button>'
					}
				`;
				document.body.appendChild(div);
				if (!state.isLoading) {
					document.getElementById('enterBtn').onclick = enterChat;
				}
				return;
			}

			if (state.showUsernamePrompt) {
				const div = document.createElement('div');
				div.id = 'overlay';
				div.className = 'modal';
				div.innerHTML = `
					<div class="modal-content">
						<div class="modal-header">CHOOSE USERNAME</div>
						${state.error ? `<div class="error">${state.error}</div>` : ''}
						<input id="unInput" type="text" value="${state.usernameInput}" maxlength="10" placeholder="Username" autocomplete="off">
						<div class="style-section">
							<span class="style-label">COLOR</span>
							<div class="color-grid" id="colorGrid">
								${COLORS.map(h => `<div class="color-option ${state.color==h?'selected':''}" data-color="${h}" style="background:hsl(${h},100%,50%);border:2px solid ${state.color==h?'white':'hsl('+h+',100%,30%)'}"></div>`).join('')}
							</div>
							<span class="style-label">BORDER</span>
							<div class="border-options">
								${['solid','dashed','dotted'].map(s => `<div class="border-option ${state.borderStyle===s?'selected':''}" data-style="${s}" style="border:2px ${s} hsl(${state.color},100%,30%)">${s.toUpperCase()}</div>`).join('')}
							</div>
						</div>
						<button id="confirmBtn">START CHATTING</button>
					</div>
				`;
				document.body.appendChild(div);
				const input = document.getElementById('unInput');
				input.focus();
				input.oninput = e => state.usernameInput = e.target.value;
				input.onkeypress = e => {
					if (e.key === 'Enter') {
						e.preventDefault();
						confirmUsername();
					}
				};
				document.querySelectorAll('.color-option').forEach(el => {
					el.onclick = () => {
						state.color = el.dataset.color;
						renderOverlay();
					};
				});
				document.querySelectorAll('.border-option').forEach(el => {
					el.onclick = () => {
						state.borderStyle = el.dataset.style;
						renderOverlay();
					};
				});
				document.getElementById('confirmBtn').onclick = confirmUsername;
				return;
			}

			const header = document.getElementById('header-area');
			if (header) {
				const userColor = `hsl(${state.color},100%,50%)`;
				header.innerHTML = `
					<input type="text" id="username-input" value="${state.username}" maxlength="10" placeholder="Username" style="border-color: ${userColor}; color: ${userColor}">
					<select id="color-select" style="border-color: ${userColor};">
						${COLORS.map(h => `<option value="${h}" ${state.color==h?'selected':''} style="color: hsl(${h},100%,50%);">Hue ${h}°</option>`).join('')}
					</select>
					<select id="border-select" style="border-color: ${userColor};">
						<option value="solid" ${state.borderStyle==='solid'?'selected':''}>Line ─</option>
						<option value="dashed" ${state.borderStyle==='dashed'?'selected':''}>Line ╌</option>
						<option value="dotted" ${state.borderStyle==='dotted'?'selected':''}>Line ┄</option>
					</select>
					<button id="update-btn" style="background: ${userColor}; border-color: ${userColor};">UPDATE</button>
					<div class="header-divider"></div>
					<select id="sound-theme-select" style="border-color: ${userColor};">
						<option value="default" ${state.soundTheme==='default'?'selected':''}>Sound Default</option>
						<option value="msn" ${state.soundTheme==='msn'?'selected':''}>Sound MSN</option>
						<option value="silent" ${state.soundTheme==='silent'?'selected':''}>Sound Silent</option>
					</select>
					<select id="animations-select" style="border-color: ${userColor};">
						<option value="true" ${state.animationsEnabled?'selected':''}>FX: On</option>
						<option value="false" ${!state.animationsEnabled?'selected':''}>FX: Off</option>
					</select>
					<button class="logout-btn" id="logoutBtn">LEAVE</button>
				`;
				
				// Live preview: update colors when dropdowns change
				document.getElementById('color-select').onchange = (e) => {
					const newColor = e.target.value;
					const previewColor = `hsl(${newColor},100%,50%)`;
					
					// Update all elements except UPDATE button and message input text
					document.body.style.borderColor = previewColor;
					document.getElementById('username-input').style.borderColor = previewColor;
					document.getElementById('username-input').style.color = previewColor;
					document.getElementById('color-select').style.borderColor = previewColor;
					document.getElementById('border-select').style.borderColor = previewColor;
					document.getElementById('sound-theme-select').style.borderColor = previewColor;
					document.getElementById('animations-select').style.borderColor = previewColor;
					
					// Update scrollbar
					let style = document.getElementById('dynamic-scrollbar-preview');
					if (!style) {
						style = document.createElement('style');
						style.id = 'dynamic-scrollbar-preview';
						document.head.appendChild(style);
					}
					style.textContent = `#messages::-webkit-scrollbar-thumb { background: ${previewColor}; }`;
				};
				
				document.getElementById('update-btn').onclick = async () => {
					const newUsername = document.getElementById('username-input').value.trim();
					const newColor = document.getElementById('color-select').value;
					const newBorderStyle = document.getElementById('border-select').value;
					const oldUsername = state.username;
					const oldColor = state.color;
					
					if (!newUsername) {
						alert('Username cannot be empty');
						return;
					}
					
					if (newUsername.length < 2 || newUsername.length > 10) {
						alert('Username must be 2-10 characters');
						return;
					}
					
					const nameChanged = newUsername !== oldUsername;
					const colorChanged = newColor !== oldColor;
					
					if (nameChanged || colorChanged) {
						let message = `${oldUsername} is now ${newUsername}`;
						await sendSystemMessage(message, oldColor, newColor);
						state.username = newUsername;
					}
					
					state.color = newColor;
					state.borderStyle = newBorderStyle;
					
					const userRef = ref(db, `users/${state.user.uid}`);
					await set(userRef, {
						username: state.username,
						color: state.color,
						borderStyle: state.borderStyle
					});
					
					await setupPresence();
					
					const messageInput = document.getElementById('messageInput');
					if (messageInput) {
						messageInput.style.color = `hsl(${state.color},100%,50%)`;
					}
					
					document.body.style.borderColor = `hsl(${state.color},100%,50%)`;
					const style = document.createElement('style');
					style.id = 'dynamic-scrollbar';
					const existingStyle = document.getElementById('dynamic-scrollbar');
					if (existingStyle) existingStyle.remove();
					style.textContent = `#messages::-webkit-scrollbar-thumb { background: hsl(${state.color},100%,50%); }`;
					document.head.appendChild(style);
					
					renderOverlay();
				};
				
				document.getElementById('sound-theme-select').onchange = (e) => {
					updateSoundTheme(e.target.value);
				};
				
				document.getElementById('animations-select').onchange = (e) => {
					state.animationsEnabled = e.target.value === 'true';
				};
			}
			
			document.getElementById('logoutBtn').onclick = async () => {
				try {
					if (state.timeoutMsgRef) {
						await onDisconnect(state.timeoutMsgRef).cancel();
					}
					
					if (state.username) {
						await sendSystemMessage(`${state.username} left`, state.color, state.color);
					}
					
					if (state.user) {
						const presenceRef = ref(db, `presence/${state.user.uid}`);
						await onDisconnect(presenceRef).cancel();
						await set(presenceRef, null);
					}
					
					state.user = null;
					state.username = '';
					state.hasJoinedChat = false;
					state.timeoutMsgRef = null;
					
					await signOut(auth);
					renderOverlay();
				} catch (err) {
					console.error('Logout error:', err);
					state.user = null;
					state.username = '';
					state.hasJoinedChat = false;
					await signOut(auth);
					renderOverlay();
				}
			};
			
			const messageInput = document.getElementById('messageInput');
			if (messageInput) {
				messageInput.style.color = `hsl(${state.color},100%,50%)`;
			}
			
			document.body.style.borderColor = `hsl(${state.color},100%,50%)`;
			const style = document.createElement('style');
			style.id = 'dynamic-scrollbar';
			const existingStyle = document.getElementById('dynamic-scrollbar');
			if (existingStyle) existingStyle.remove();
			style.textContent = `#messages::-webkit-scrollbar-thumb { background: hsl(${state.color},100%,50%); }`;
			document.head.appendChild(style);
		}

		async function setupPresence() {
			if (!state.user || !state.username) return;
			
			const presenceRef = ref(db, `presence/${state.user.uid}`);
			const connectedRef = ref(db, '.info/connected');
			
			onValue(connectedRef, async (snapshot) => {
				if (snapshot.val() === true && state.user && state.username) {
					await set(presenceRef, {
						username: state.username,
						color: state.color,
						online: true,
						timestamp: Date.now()
					});
					
					await onDisconnect(presenceRef).remove();
					
					const timeoutMsgKey = `timeout_${state.user.uid}_${Date.now()}`;
					const timeoutMsgRef = ref(db, `messages/${timeoutMsgKey}`);
					
					await onDisconnect(timeoutMsgRef).set({
						text: `${state.username} timed out`,
						timestamp: Date.now(),
						type: 'system',
						oldColor: state.color,
						newColor: state.color
					});
					
					state.timeoutMsgRef = timeoutMsgRef;
				}
			});
		}

		onAuthStateChanged(auth, async user => {
			if (user) {
				const snap = await get(ref(db, `users/${user.uid}`));
				if (!snap.exists() || !snap.val()?.username) {
					state.user = user;
					state.showUsernamePrompt = true;
				} else {
					state.user = user;
					const data = snap.val();
					state.username = data.username;
					state.color = data.color || '180';
					state.borderStyle = data.borderStyle || 'solid';
					state.showUsernamePrompt = false;
					
					if (!state.hasJoinedChat) {
						await sendSystemMessage(`${state.username} joined`, state.color, state.color);
						state.hasJoinedChat = true;
						await setupPresence();
						
						if (state.soundTheme !== 'silent') {
							enterSound.currentTime = 0;
							enterSound.play().catch(() => {});
						}
					}
				}
			} else {
				state.user = null;
				state.username = '';
				state.showUsernamePrompt = false;
				state.hasJoinedChat = false;
			}
			state.isLoading = false;
			renderOverlay();
		});

		renderOverlay();
	</script>
</body>
</html>